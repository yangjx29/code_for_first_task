import sys
import os
sys.path.append('../../')
sys.path.append('../../python_parser')
sys.path.append('../code')
import json
from codebleu import calc_codebleu

eval_data_file = '../dataset/test_subs_gan_0_400.jsonl'
adv_data_file = '/data/yjx/code_for_first_task/CodeTAE/CodeBERT/Defect-detection/code/adv_codebert_ensemble_train.txt'


source_codes = []   
with open(eval_data_file, 'r') as f:
    for line in f:
        js=json.loads(line.strip())
        code = js['func']
        source_codes.append(code)
adv_source_codes = []
with open(adv_data_file, 'r') as f:
    for line in f:
        adv_source_codes.append(line.strip())
assert(len(source_codes) == len(adv_source_codes))
# print(len(adv_source_codes),len(source_codes))
bleu_score_total = 0
for i in range(len(source_codes)):
    bleu_score = calc_codebleu([source_codes[i]], [adv_source_codes[i]], lang="c", weights=(0.25, 0.25, 0.25, 0.25), tokenizer=None)
    print(f'bleu_score for {i}th code: {bleu_score}')
    bleu_score_total += bleu_score['codebleu']

print("Average BLEU score: ", round(bleu_score_total/len(source_codes),2))