import os
import subprocess
import json
import pandas as pd

def extract_adversarial_code(csv_file):
    # 读取CSV文件
    df = pd.read_csv(csv_file)
    
    # 获取所有对抗样本代码
    adversarial_codes = df['Adversarial Code'].tolist()
    
    # 过滤掉空值或无效值
    adversarial_codes = [code for code in adversarial_codes if isinstance(code, str) and code.strip()]
    
    # 可以同时获取其他相关信息
    attack_results = []
    for index, row in df.iterrows():
        attack_info = {
            'index': index,
            'adv_code': row['Adversarial Code'],
            'is_success': row['Is Success'],
            'original_pred': row['Original Prediction'],
            'adv_pred': row['Adv Prediction'],
            'attack_type': row['Attack Type'],
            'changed_tokens': row['No. Changed Tokens'],
            'time_cost': row['Time Cost']
        }
        attack_results.append(attack_info)
    
    return adversarial_codes, attack_results

def check_syntax(code, filename):
    # 将代码写入临时文件
    with open(f"temp_{filename}.c", "w") as f:
        f.write(code)
    
    # 使用gcc检查语法
    result = subprocess.run(['gcc', '-fsyntax-only', f'temp_{filename}.c'], 
                          capture_output=True,
                          text=True)
    
    # 删除临时文件
    os.remove(f"temp_{filename}.c")
    
    return result.returncode == 0

def analyze_syntax():
    # 读取原始代码
    original_codes = []
    with open("../../dataset/test_0_400.jsonl", "r") as f:
        for line in f:
            data = json.loads(line)
            original_codes.append(data['func'])
    
    # 读取对抗代码
    adversarial_codes = []
    # with open("../graphcodebert_test_0_400_adv.jsonl", "r") as f:
    #     current_code = ""
        
    #     for line in f:
    #         data = json.loads(line)
    #         adversarial_codes.append(data['func'])


    adversarial_codes, _= extract_adversarial_code("/data/yjx/code_for_first_task/ALERT/CodeBert/Defect-detection/code/Alert_20_20.csv")

    
    # 检查语法正确性
    original_correct = sum(1 for code in original_codes if check_syntax(code, "orig"))
    adversarial_correct = sum(1 for code in adversarial_codes if check_syntax(code, "adv"))
    
    return {
        "original": {
            "total": len(original_codes),
            "correct": original_correct,
            "rate": original_correct / len(original_codes)
        },
        "adversarial": {
            "total": len(adversarial_codes),
            "correct": adversarial_correct,
            "rate": adversarial_correct / len(adversarial_codes)
        }
    }
