% Txl v10.8 (7.5.20) (c) 1988-2020 Queen's University at Kingston
% Parser for Java programs
% zhangweiwei, 202009
% 这个文件的主要作用是用来删除文件里面的空语句 ;

include "java.grm"

% Main function
function main
    replace [package_declaration]
        P [package_declaration]
    by 
        P [changeFunction] 
end function

% 修改文件里面的每个方法
function changeFunction
    replace [package_declaration]
        P [package_declaration]
    construct Methods [repeat method_declaration]
        _ [^ P]
    construct NewMethods [repeat method_declaration]
        _ [changeMethodDefinition each Methods] 
    by 
        P [replaceMethod each Methods NewMethods]
end function

function replaceMethod MD [method_declaration] NewMD [method_declaration]
    replace [package_declaration]
        P [package_declaration]
    by  
        P [$ MD NewMD]
end function

% 修改方法定义
function changeMethodDefinition MD [method_declaration]
    replace [repeat method_declaration]
        RMethodDefine [repeat method_declaration]   
    construct NewMD [method_declaration]
        MD [translateJavaMethod]
    by 
        RMethodDefine [. NewMD]
end function

function translateJavaMethod
    replace $[method_declaration]
        Modifiers [repeat modifier] Gen [opt generic_parameter] 
        Type [type_specifier] Declarator [method_declarator] 
        Throws [opt throws] Body [method_body]
    by
        Modifiers Gen Type Declarator Throws 
        Body [changeCompound]
end function

% 处理方法体中的块
function changeCompound
    replace [method_body]
        '{ RS [repeat declaration_or_statement] '} % Java block
    by 
        '{ RS [changeCompoundStatementBody] [removeDoubleBracket] '}
    |
    replace [method_body] % Handle abstract or default methods
        '; % Abstract method
    by 
        ';
    |
    replace [method_body]
        'default Value [annotation_value] ';
    by 
        'default Value ';
end function

rule removeDoubleBracket
    replace [block]
        '{{ NCSB [repeat declaration_or_statement] '}}
    by 
        '{ NCSB [changeCompoundStatementBody] '}
end rule

rule changeCompoundStatementBody
    replace $[repeat declaration_or_statement]
        Dos [repeat declaration_or_statement]
    construct NDos [repeat declaration_or_statement]
        _ [removeNullStatement each Dos]
    by 
        NDos 
end rule

% 删除空语句
function removeNullStatement BI [declaration_or_statement]
    replace [repeat declaration_or_statement]
        DE [repeat declaration_or_statement]
    construct NDE [repeat declaration_or_statement]
        _ [testIsStatement BI]
    construct NNDE [repeat declaration_or_statement]
        NDE [testIsDeclaration BI]
    by
        DE [. NNDE]
end function 

% 判断是否是声明
function testIsDeclaration BI [declaration_or_statement]
    replace [repeat declaration_or_statement]
        RBI [repeat declaration_or_statement]
    deconstruct BI
        DE [declaration]
    deconstruct not DE
        '; % Empty statement in Java
    by
        RBI [. BI]        
end function

% 判断是否是语句
function testIsStatement BI [declaration_or_statement]
    replace [repeat declaration_or_statement]
        RBI [repeat declaration_or_statement]
    deconstruct BI
        St [statement]
    by 
        RBI [. BI]
end function

% 删除空语句完成
% ---------------------------------------------------------------